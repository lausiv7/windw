# 011. WindWalker 하이브리드 클라우드 구축 및 운영 가이드

## 📋 개요

WindWalker IDE의 안정적인 서비스 운영을 위한 하이브리드 클라우드 아키텍처 구축 가이드입니다. 로컬 클라우드(Proxmox)와 상용 클라우드의 조합을 통해 비용 절감과 무중단 서비스를 실현합니다.

### 🎯 하이브리드 클라우드 전략
- **로컬 클라우드(Proxmox)**: 주 서비스 환경, 비용 효율적 운영
- **상용 클라우드**: 백업 및 보조 환경, 트래픽 분산, 재해 복구
- **Docker 기반**: 일관된 배포 환경, 쉬운 마이그레이션

## 🏗️ 전체 시스템 아키텍처

```mermaid
graph TB
    subgraph "사용자 레이어"
        A[사용자] --> B[Load Balancer/CDN]
    end
    
    subgraph "로컬 클라우드 (Proxmox)"
        B --> C[Code-Server Cluster]
        B --> D[Preview Server]
        B --> E[RAG API Server]
        B --> F[Authentication Server]
        G[Meilisearch] --> E
        H[PostgreSQL] --> F
    end
    
    subgraph "상용 클라우드 (백업/보조)"
        I[Code-Server Backup]
        J[Database Backup]
        K[File Storage Backup]
    end
    
    subgraph "외부 서비스"
        L[OpenAI API]
        M[GitHub API]
        N[Monitoring/Logging]
    end
    
    C --> I
    H --> J
    E --> L
    F --> M
    
    style C fill:#ff9999
    style E fill:#99ff99
    style G fill:#99ccff
```

## 🐳 Docker Compose 완전 구성

### 📁 프로젝트 구조
```
windwalker/
├── docker-compose.yml              # 메인 서비스 구성
├── docker-compose.prod.yml         # 프로덕션 오버라이드
├── docker-compose.dev.yml          # 개발 환경 오버라이드
├── start-docker.sh                 # 개발용 시작 스크립트
├── deploy-prod.sh                  # 프로덕션 배포 스크립트
├── stop-docker.sh                  # 서비스 종료 스크립트
├── backup-data.sh                  # 데이터 백업 스크립트
└── monitoring/                     # 모니터링 설정
    ├── prometheus.yml
    ├── grafana/
    └── alerts/
```

### 📄 완전한 docker-compose.yml

```yaml
version: '3.8'

services:
  # Code-Server (VS Code Web) - 메인 IDE
  code-server:
    image: codercom/code-server:latest
    container_name: windwalker-ide
    ports:
      - "8080:8080"
    volumes:
      # 워크스페이스 (사용자 프로젝트)
      - ./workspace:/home/coder/workspace
      # VS Code 확장 및 설정
      - ./extensions:/home/coder/.local/share/code-server/extensions
      - ./vscode-config:/home/coder/.local/share/code-server/User
      # Docker 소켓 (컨테이너 내에서 Docker 사용)
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PASSWORD=windwalker2024
      - DOCKER_USER=coder
    user: "1000:1000"
    restart: unless-stopped
    command: >
      --bind-addr 0.0.0.0:8080
      --user-data-dir /home/coder/.local/share/code-server
      --extensions-dir /home/coder/.local/share/code-server/extensions
      --disable-telemetry
      /home/coder/workspace
    networks:
      - windwalker-network
    depends_on:
      - postgres
      - redis

  # Preview Server - 실시간 프리뷰
  preview-server:
    image: nginx:alpine
    container_name: windwalker-preview
    ports:
      - "3000:80"
    volumes:
      - ./workspace/dist:/usr/share/nginx/html:ro
      - ./nginx/preview.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    depends_on:
      - code-server
    networks:
      - windwalker-network

  # RAG API Server - AI 및 코드 분석
  rag-api:
    build: 
      context: ./api-server
      dockerfile: Dockerfile
    container_name: windwalker-rag-api
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - MEILISEARCH_HOST=http://meilisearch:7700
      - MEILISEARCH_KEY=windwalker-search-key
      - POSTGRES_URL=postgresql://windwalker:windwalker2024@postgres:5432/windwalker
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./api-server/logs:/app/logs
    restart: unless-stopped
    depends_on:
      - meilisearch
      - postgres
      - redis
    networks:
      - windwalker-network

  # Meilisearch - 코드 검색 엔진
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: windwalker-search
    ports:
      - "7700:7700"
    environment:
      - MEILI_ENV=production
      - MEILI_MASTER_KEY=windwalker-search-key
      - MEILI_DB_PATH=/meili_data
    volumes:
      - search_data:/meili_data
    restart: unless-stopped
    networks:
      - windwalker-network

  # PostgreSQL - 메인 데이터베이스
  postgres:
    image: postgres:15-alpine
    container_name: windwalker-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=windwalker
      - POSTGRES_USER=windwalker
      - POSTGRES_PASSWORD=windwalker2024
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    networks:
      - windwalker-network

  # Redis - 캐시 및 세션 저장소
  redis:
    image: redis:7-alpine
    container_name: windwalker-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass windwalker2024
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - windwalker-network

  # Authentication Server - 사용자 인증
  auth-server:
    build:
      context: ./auth-server
      dockerfile: Dockerfile
    container_name: windwalker-auth
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET}
      - POSTGRES_URL=postgresql://windwalker:windwalker2024@postgres:5432/windwalker
      - REDIS_URL=redis://redis:6379
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    networks:
      - windwalker-network

  # File Storage Server - 파일 업로드/다운로드
  file-server:
    build:
      context: ./file-server
      dockerfile: Dockerfile
    container_name: windwalker-files
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - STORAGE_PATH=/app/storage
      - MAX_FILE_SIZE=100MB
    volumes:
      - file_storage:/app/storage
    restart: unless-stopped
    networks:
      - windwalker-network

  # WebSocket Server - 실시간 통신
  websocket-server:
    build:
      context: ./websocket-server
      dockerfile: Dockerfile
    container_name: windwalker-websocket
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
    restart: unless-stopped
    depends_on:
      - redis
    networks:
      - windwalker-network

  # Load Balancer - 트래픽 분산
  nginx:
    image: nginx:alpine
    container_name: windwalker-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    restart: unless-stopped
    depends_on:
      - code-server
      - rag-api
      - auth-server
    networks:
      - windwalker-network

  # Monitoring - Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: windwalker-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    restart: unless-stopped
    networks:
      - windwalker-network

  # Monitoring - Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: windwalker-grafana
    ports:
      - "3010:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=windwalker2024
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    restart: unless-stopped
    depends_on:
      - prometheus
    networks:
      - windwalker-network

networks:
  windwalker-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  workspace_data:
  extensions_data:
  search_data:
  postgres_data:
  redis_data:
  file_storage:
  prometheus_data:
  grafana_data:
```

## 🚀 배포 및 운영 스크립트

### 📄 start-docker.sh (개발용)
```bash
#!/bin/bash

echo "🚀 WindWalker 하이브리드 클라우드 개발 환경 시작..."

# 환경 변수 로드
if [ -f .env ]; then
    export $(cat .env | xargs)
fi

# Docker 서비스 상태 확인
if ! systemctl is-active --quiet docker; then
    echo "🔧 Docker 서비스 시작 중..."
    sudo systemctl start docker
fi

# 권한 설정
echo "🔒 권한 설정..."
sudo chown -R 1000:1000 workspace extensions vscode-config 2>/dev/null || true
chmod -R 755 workspace extensions vscode-config 2>/dev/null || true

# 개발 환경 실행
echo "🐳 개발 환경 Docker Compose 실행 중..."
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

echo ""
echo "✅ WindWalker 개발 환경이 시작되었습니다!"
echo ""
echo "🌐 서비스 접속 정보:"
echo "  📝 IDE: http://localhost:8080 (패스워드: windwalker2024)"
echo "  🔍 프리뷰: http://localhost:3000"
echo "  🤖 RAG API: http://localhost:3001"
echo "  🔐 인증: http://localhost:3002"
echo "  📊 모니터링: http://localhost:3010 (admin/windwalker2024)"
echo ""
echo "📋 유용한 명령어:"
echo "  docker-compose logs -f [서비스명]  # 로그 확인"
echo "  docker-compose down               # 서비스 종료"
echo "  ./stop-docker.sh                  # 빠른 종료"
```

### 📄 deploy-prod.sh (프로덕션용)
```bash
#!/bin/bash

echo "🚀 WindWalker 프로덕션 배포 시작..."

# 환경 변수 확인
if [ ! -f .env.prod ]; then
    echo "❌ .env.prod 파일이 필요합니다."
    exit 1
fi

export $(cat .env.prod | xargs)

# 백업 생성
echo "💾 현재 데이터 백업 중..."
./backup-data.sh

# 이미지 빌드
echo "🔨 Docker 이미지 빌드 중..."
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build

# 무중단 배포
echo "🔄 무중단 배포 실행 중..."
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --remove-orphans

# 헬스 체크
echo "🏥 서비스 헬스 체크 중..."
sleep 30

services=("code-server" "rag-api" "auth-server" "nginx")
for service in "${services[@]}"; do
    if docker-compose ps $service | grep -q "Up"; then
        echo "✅ $service: 정상 실행 중"
    else
        echo "❌ $service: 실행 실패"
        exit 1
    fi
done

echo ""
echo "🎉 프로덕션 배포 완료!"
echo "🌐 서비스 URL: https://your-domain.com"
```

### 📄 backup-data.sh
```bash
#!/bin/bash

BACKUP_DIR="./backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

echo "💾 WindWalker 데이터 백업 시작..."

# PostgreSQL 백업
echo "📊 데이터베이스 백업 중..."
docker exec windwalker-postgres pg_dump -U windwalker windwalker > $BACKUP_DIR/postgres_backup.sql

# Redis 백업
echo "🔄 Redis 데이터 백업 중..."
docker exec windwalker-redis redis-cli --rdb - > $BACKUP_DIR/redis_backup.rdb

# 워크스페이스 백업
echo "📁 워크스페이스 백업 중..."
tar -czf $BACKUP_DIR/workspace_backup.tar.gz ./workspace

# Meilisearch 데이터 백업
echo "🔍 검색 인덱스 백업 중..."
docker exec windwalker-search curl -X POST 'http://localhost:7700/dumps' \
  -H 'Authorization: Bearer windwalker-search-key' > $BACKUP_DIR/meilisearch_backup.dump

echo "✅ 백업 완료: $BACKUP_DIR"
```

## 📊 모니터링 및 로깅

### Prometheus 설정 (monitoring/prometheus.yml)
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'windwalker-services'
    static_configs:
      - targets: ['code-server:8080', 'rag-api:3001', 'auth-server:3002']
  
  - job_name: 'infrastructure'
    static_configs:
      - targets: ['postgres:5432', 'redis:6379', 'meilisearch:7700']
```

### Grafana 대시보드
- **시스템 리소스**: CPU, 메모리, 디스크 사용량
- **서비스 상태**: 응답 시간, 에러율, 처리량
- **사용자 활동**: 접속자 수, 프로젝트 생성, API 호출
- **데이터베이스**: 쿼리 성능, 연결 수, 스토리지

## 🔒 보안 설정

### SSL/TLS 설정
```bash
# Let's Encrypt 인증서 발급
certbot certonly --webroot -w /var/www/html -d your-domain.com

# 인증서 자동 갱신
echo "0 2 * * * certbot renew --quiet" | crontab -
```

### 방화벽 설정
```bash
# UFW 방화벽 설정
ufw allow 22/tcp      # SSH
ufw allow 80/tcp      # HTTP
ufw allow 443/tcp     # HTTPS
ufw enable
```

## 🌐 하이브리드 클라우드 운영

### 로컬 클라우드 (Proxmox) 설정
1. **VM 생성**: Ubuntu 22.04 LTS, 16GB RAM, 8 CPU, 500GB SSD
2. **Docker 설치**: 위 스크립트로 자동 설치
3. **백업 설정**: 매일 자동 백업, 클라우드 동기화

### 상용 클라우드 연동
```bash
# AWS S3 백업 동기화
aws s3 sync ./backups s3://windwalker-backups/

# Cloudflare CDN 설정
# DNS: your-domain.com -> Proxmox IP
# 백업: backup.your-domain.com -> AWS/Azure
```

### 무중단 서비스 전략
1. **로드 밸런싱**: Nginx + Cloudflare
2. **헬스 체크**: 서비스 상태 자동 모니터링
3. **자동 복구**: 장애 시 백업 서버로 자동 전환
4. **데이터 동기화**: 실시간 백업 및 복제

## 📈 성능 최적화

### 리소스 최적화
- **컨테이너 리소스 제한**: CPU/메모리 제한 설정
- **이미지 최적화**: 멀티 스테이지 빌드, Alpine 기반
- **캐시 활용**: Redis 캐시, CDN 활용

### 스케일링 전략
- **수평 확장**: 코드 서버 인스턴스 자동 증설
- **수직 확장**: 리소스 사용량에 따른 자동 스케일링
- **로드 밸런싱**: 트래픽 분산 및 지역별 서버

## 🎯 운영 체크리스트

### 일일 운영
- [ ] 서비스 상태 확인
- [ ] 로그 모니터링
- [ ] 백업 상태 확인
- [ ] 성능 지표 검토

### 주간 운영
- [ ] 보안 업데이트
- [ ] 데이터베이스 최적화
- [ ] 용량 계획 검토
- [ ] 백업 복구 테스트

### 월간 운영
- [ ] 전체 시스템 점검
- [ ] 비용 분석 및 최적화
- [ ] 재해 복구 훈련
- [ ] 아키텍처 개선 계획

이 가이드를 통해 WindWalker IDE의 안정적이고 확장 가능한 하이브리드 클라우드 환경을 구축하고 운영할 수 있습니다.