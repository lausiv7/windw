# WindWalker WebView ÌÜµÏã† ÏïÑÌÇ§ÌÖçÏ≤ò Î∞è Íµ¨ÌòÑ

## üîÑ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÌîåÎ°úÏö∞

```mermaid
sequenceDiagram
    participant User as üë§ ÏÇ¨Ïö©Ïûê
    participant ChatWebView as üí¨ AI Ï±ÑÌåÖ WebView
    participant PreviewWebView as üñ•Ô∏è ÌîÑÎ¶¨Î∑∞ WebView
    participant Extension as üîå VS Code Extension
    participant FileSystem as üìÅ ÌååÏùºÏãúÏä§ÌÖú
    participant BuildService as üî® ÎπåÎìú ÏÑúÎπÑÏä§
    participant RAG as üß† RAG API
    participant LLM as ü§ñ LLM API

    User->>ChatWebView: "Î°úÍ∑∏Ïù∏ Í∏∞Îä• Ï∂îÍ∞ÄÌï¥Ï§ò"
    ChatWebView->>Extension: postMessage({type: 'chat:request'})
    Extension->>RAG: ÏΩîÎìúÎ≤†Ïù¥Ïä§ Î∂ÑÏÑù ÏöîÏ≤≠
    RAG-->>Extension: Í¥ÄÎ†® ÏΩîÎìú Ïª®ÌÖçÏä§Ìä∏
    Extension->>LLM: ÌîÑÎ°¨ÌîÑÌä∏ + Ïª®ÌÖçÏä§Ìä∏
    LLM-->>Extension: ÏÉùÏÑ±Îêú ÏΩîÎìú
    Extension->>FileSystem: ÌååÏùº ÏÉùÏÑ±/ÏàòÏ†ï
    Extension->>ChatWebView: postMessage({type: 'chat:response'})
    Extension->>BuildService: npm run build
    BuildService-->>Extension: ÎπåÎìú ÏôÑÎ£å
    Extension->>PreviewWebView: postMessage({type: 'preview:update'})
    PreviewWebView->>User: Ïã§ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
```

## üèóÔ∏è ÏÉÅÏÑ∏ ÏïÑÌÇ§ÌÖçÏ≤ò

```mermaid
graph TB
    subgraph "VS Code Extension Host"
        A[Extension Main] --> B[WebView Manager]
        A --> C[File Manager]
        A --> D[Build Manager]
        A --> E[RAG Client]
        A --> F[Mode Manager]
        
        B --> G[Chat WebView Provider]
        B --> H[Preview WebView Provider]
    end
    
    subgraph "WebView Contexts"
        I[Chat WebView<br/>iframe: chat UI]
        J[Preview WebView<br/>iframe: preview UI]
    end
    
    subgraph "VS Code Workspace"
        K[Source Files]
        L[Build Output]
        M[Node Modules]
    end
    
    subgraph "External Services"
        N[RAG API Server]
        O[LLM API]
        P[Build Service]
    end
    
    G --> I
    H --> J
    C --> K
    D --> L
    E --> N
    N --> O
    D --> P
    
    style A fill:#ffffff
    style I fill:#ffffff
    style J fill:#ffffff
```

## üìÅ ÌîÑÎ°úÏ†ùÌä∏ Íµ¨Ï°∞

```
windwalker-extension/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ extension.ts                    # ÌôïÏû• ÏßÑÏûÖÏ†ê
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ModeManager.ts             # Î™®Îìú Í¥ÄÎ¶¨
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WebViewManager.ts          # WebView Í¥ÄÎ¶¨Ïûê
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileManager.ts             # ÌååÏùº ÏãúÏä§ÌÖú Í¥ÄÎ¶¨
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BuildManager.ts            # ÎπåÎìú ÌîÑÎ°úÏÑ∏Ïä§ Í¥ÄÎ¶¨
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ MessageBridge.ts           # Extension ‚Üî WebView ÌÜµÏã†
‚îÇ   ‚îú‚îÄ‚îÄ providers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatWebViewProvider.ts     # Ï±ÑÌåÖ WebView Ï†úÍ≥µÏûê
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PreviewWebViewProvider.ts  # ÌîÑÎ¶¨Î∑∞ WebView Ï†úÍ≥µÏûê
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RAGService.ts              # RAG API ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LLMService.ts              # LLM API ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CodeGenerationService.ts   # ÏΩîÎìú ÏÉùÏÑ± ÏÑúÎπÑÏä§
‚îÇ   ‚îî‚îÄ‚îÄ webview/
‚îÇ       ‚îú‚îÄ‚îÄ chat/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.html             # Ï±ÑÌåÖ UI
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ script.js              # Ï±ÑÌåÖ Î°úÏßÅ
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ style.css
‚îÇ       ‚îî‚îÄ‚îÄ preview/
‚îÇ           ‚îú‚îÄ‚îÄ index.html             # ÌîÑÎ¶¨Î∑∞ UI
‚îÇ           ‚îú‚îÄ‚îÄ script.js              # ÌîÑÎ¶¨Î∑∞ Î°úÏßÅ
‚îÇ           ‚îî‚îÄ‚îÄ style.css
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## üîå ÌïµÏã¨ Íµ¨ÌòÑ ÏΩîÎìú

### 1. Extension ÏßÑÏûÖÏ†ê (extension.ts)

```typescript
import * as vscode from 'vscode';
import { WebViewManager } from './core/WebViewManager';
import { FileManager } from './core/FileManager';
import { BuildManager } from './core/BuildManager';
import { ModeManager, WindWalkerMode } from './core/ModeManager';
import { MessageBridge } from './core/MessageBridge';

export function activate(context: vscode.ExtensionContext) {
    console.log('WindWalker Extension ÌôúÏÑ±Ìôî');
    
    // ÌïµÏã¨ Îß§ÎãàÏ†ÄÎì§ Ï¥àÍ∏∞Ìôî
    const modeManager = new ModeManager();
    const fileManager = new FileManager(context);
    const buildManager = new BuildManager(context);
    const webViewManager = new WebViewManager(context);
    const messageBridge = new MessageBridge();
    
    // WebViewÎì§ Îì±Î°ù
    const chatProvider = webViewManager.createChatProvider();
    const previewProvider = webViewManager.createPreviewProvider();
    
    // Message Bridge ÏÑ§Ï†ï - ExtensionÍ≥º WebView Í∞Ñ ÌÜµÏã† ÌóàÎ∏å
    messageBridge.setupCommunication(chatProvider, previewProvider, {
        fileManager,
        buildManager,
        modeManager
    });
    
    // Î™ÖÎ†πÏñ¥ Îì±Î°ù
    const commands = [
        vscode.commands.registerCommand('windwalker.switchMode', () => {
            const currentMode = modeManager.getCurrentMode();
            const newMode = currentMode === WindWalkerMode.CODE 
                ? WindWalkerMode.PROTOTYPE 
                : WindWalkerMode.CODE;
            modeManager.switchMode(newMode);
        }),
        
        vscode.commands.registerCommand('windwalker.openChat', () => {
            chatProvider.show();
        }),
        
        vscode.commands.registerCommand('windwalker.openPreview', () => {
            previewProvider.show();
        })
    ];
    
    context.subscriptions.push(...commands);
}
```

### 2. WebView Manager (WebViewManager.ts)

```typescript
import * as vscode from 'vscode';
import { ChatWebViewProvider } from '../providers/ChatWebViewProvider';
import { PreviewWebViewProvider } from '../providers/PreviewWebViewProvider';

export class WebViewManager {
    private context: vscode.ExtensionContext;
    
    constructor(context: vscode.ExtensionContext) {
        this.context = context;
    }
    
    createChatProvider(): ChatWebViewProvider {
        const provider = new ChatWebViewProvider(this.context);
        
        // WebView Provider Îì±Î°ù
        this.context.subscriptions.push(
            vscode.window.registerWebviewViewProvider(
                'windwalker.chatView',
                provider,
                {
                    webviewOptions: {
                        retainContextWhenHidden: true
                    }
                }
            )
        );
        
        return provider;
    }
    
    createPreviewProvider(): PreviewWebViewProvider {
        const provider = new PreviewWebViewProvider(this.context);
        
        this.context.subscriptions.push(
            vscode.window.registerWebviewViewProvider(
                'windwalker.previewView',
                provider,
                {
                    webviewOptions: {
                        retainContextWhenHidden: true
                    }
                }
            )
        );
        
        return provider;
    }
}
```

### 3. Ï±ÑÌåÖ WebView Provider (ChatWebViewProvider.ts)

```typescript
import * as vscode from 'vscode';
import * as path from 'path';

export class ChatWebViewProvider implements vscode.WebviewViewProvider {
    private _view?: vscode.WebviewView;
    private context: vscode.ExtensionContext;
    
    constructor(context: vscode.ExtensionContext) {
        this.context = context;
    }
    
    resolveWebviewView(webviewView: vscode.WebviewView): void {
        this._view = webviewView;
        
        webviewView.webview.options = {
            enableScripts: true,
            localResourceRoots: [
                vscode.Uri.joinPath(this.context.extensionUri, 'out'),
                vscode.Uri.joinPath(this.context.extensionUri, 'webview')
            ]
        };
        
        webviewView.webview.html = this.getChatHtml(webviewView.webview);
        
        // WebView ‚Üí Extension Î©îÏãúÏßÄ ÏàòÏã†
        webviewView.webview.onDidReceiveMessage(async (message) => {
            switch (message.type) {
                case 'chat:request':
                    await this.handleChatRequest(message.data);
                    break;
                case 'chat:ready':
                    this.onWebViewReady();
                    break;
            }
        });
    }
    
    private async handleChatRequest(data: { message: string, mode: string }) {
        // MessageBridgeÎ•º ÌÜµÌï¥ Îã§Î•∏ Ïª¥Ìè¨ÎÑåÌä∏Îì§Í≥º ÌÜµÏã†
        vscode.commands.executeCommand('windwalker.internal.processChatRequest', data);
    }
    
    private getChatHtml(webview: vscode.Webview): string {
        const scriptUri = webview.asWebviewUri(
            vscode.Uri.joinPath(this.context.extensionUri, 'webview', 'chat', 'script.js')
        );
        const styleUri = webview.asWebviewUri(
            vscode.Uri.joinPath(this.context.extensionUri, 'webview', 'chat', 'style.css')
        );
        
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link href="${styleUri}" rel="stylesheet">
            <title>WindWalker AI Chat</title>
        </head>
        <body>
            <div id="chat-container">
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <textarea id="chat-input" placeholder="@Codebase Î°úÍ∑∏Ïù∏ Í∏∞Îä• Ï∂îÍ∞ÄÌï¥Ï§ò"></textarea>
                    <button id="send-button">Ï†ÑÏÜ°</button>
                </div>
            </div>
            <script src="${scriptUri}"></script>
        </body>
        </html>`;
    }
    
    // Extension ‚Üí WebView Î©îÏãúÏßÄ Î∞úÏÜ°
    postMessage(message: any) {
        this._view?.webview.postMessage(message);
    }
    
    show() {
        this._view?.show();
    }
}
```

### 4. Ï±ÑÌåÖ WebView Script (webview/chat/script.js)

```javascript
(function() {
    const vscode = acquireVsCodeApi();
    
    // DOM ÏöîÏÜåÎì§
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    
    // WebView Ï§ÄÎπÑ ÏôÑÎ£å ÏïåÎ¶º
    vscode.postMessage({ type: 'chat:ready' });
    
    // Î©îÏãúÏßÄ Ï†ÑÏÜ°
    function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ UI Ï∂îÍ∞Ä
        addMessage('user', message);
        
        // ExtensionÏóê ÏöîÏ≤≠ Ï†ÑÏÜ°
        vscode.postMessage({
            type: 'chat:request',
            data: {
                message: message,
                timestamp: Date.now()
            }
        });
        
        chatInput.value = '';
        
        // AI ÏùëÎãµ ÎåÄÍ∏∞ UI
        addMessage('assistant', 'ÏÉùÍ∞Å Ï§ë...', { isLoading: true });
    }
    
    // UIÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
    function addMessage(sender, content, options = {}) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        if (options.isLoading) {
            messageDiv.id = 'loading-message';
            messageDiv.innerHTML = `
                <div class="loading-spinner"></div>
                <span>${content}</span>
            `;
        } else {
            messageDiv.innerHTML = `